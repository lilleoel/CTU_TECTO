---
title: "Statistical report for \n TECTO trial"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  word_document:
    toc: yes
    toc_depth: '2'
subtitle: Using simulated data
---

```{r setup, include=FALSE}
source("_scripts/_functions.R")
source("_scripts/_sim_data.R")
#source("_scripts/_import_data.R")
#source("_scripts/_data_handling.R")
#Kruskal wallis if not fullfilled.
```

\newpage
# Table 1 - Participant characteristics

```{r}
tbl_func(df,strat_var="group",vars=c("Age","Gender","Nationality","Parental education level","Parental nationality",
                                     "Full-scale IQ","OCD-subtype",
                                     "Comorbidities|Depressive disorders","Comorbidities|Anxiety disorders",
                                     "Comorbidities|Adjustment disorders","Comorbidities|Eating disorders",
                                     "Comorbidities|Personality disorders","Comorbidities|Aspergers Syndrome",
                                     "Comorbidities|Hyperkinetic disorders","Comorbidities|Conduct disorders",
                                     "Comorbidities|Tics/Tourettes syndrome","Comorbidities|Elimination disorders"))


```

*The education-level from the parent with the highest education is used (using ISCED).*

\newpage
# Table 2 - Baseline psychopathology

```{r}
df_baseline <- df[,grepl("pt_id|group|_0", colnames(df))]
colnames(df_baseline) <- gsub("_0","",colnames(df_baseline))
tbl_func(df_baseline,strat_var="group",vars=c("SRS","CY-BOCS","COIS-R","CGI-S","CGAS","TOCS","TAFQ-A","Kidscreen-10"), Grepl=T)

```

*SRS: Social responsiveness scale; CY-BOCS: Children’s Yale–Brown Obsessive Compulsive Scale; COIS-R: Child Obsessive-Compulsive Impact Scale-Revised; CGI-S: Clinical Global Impressions Severity; CGAS: Children’s Global Assessment Scale; TOCS: Toronto Obsessive-Compulsive Scale; TAFQ-A: Though-Action Fusion Questionaire for Adolescents.*

\newpage
# Table 3 - Family characteristics

```{r}
df_t3 <- df[grepl("group|FES|PSS_0|FAS_0",colnames(df))]
colnames(df_t3) <- gsub("_0","",colnames(df_t3))
tbl_func(df_t3,strat_var="group",vars=c("FES","PSS","FAS"), Grepl=T)

```

*For PSS, FES, and SRS the average of the parents who responded is presented. FES: Family Environment Scale; PSS: Parental stress scale; FAS: Family Accommodation Scale for Obsessive-Compulsive Disorder.*

\newpage
# Figure 1 - Psychopathological scores

```{r, fig.height=8}

ggarrange(figScores(df,"CY-BOCS", lin_reg=T),
          figScores(df,"COIS-R", lin_reg=T),
          figScores(df,"CGI-S", lin_reg=T),
          figScores(df,"CGI-I", lin_reg_simple=T),
          figScores(df,"CGAS", lin_reg=T),
          figScores(df,"TOCS", lin_reg=T),
          figScores(df,"Kidscreen-10", lin_reg=T),
          figScores(df,"TAFQ-A", lin_reg=T),
          figScores(df,"FAS", lin_reg=T, simple=F),
          figScores(df,"PSS", lin_reg=T, simple=F),
             ncol=1, common.legend=T, legend="bottom") +
  theme(plot.margin = margin(0.1,0.1,0.1,0.1, "cm"))

```

*CY-BOCS: Children’s Yale–Brown Obsessive Compulsive Scale; COIS-R: Child Obsessive-Compulsive Impact Scale-Revised; CGI-S: Clinical Global Impressions Severity; CGI-I: Clinical Global Impressions Improvement; Children’s Global Assessment Scale; TOCS: Toronto Obsessive-Compulsive Scale; TAFQ-A: Though-Action Fusion Questionaire for Adolescents; FAS: Family Accommodation Scale for Obsessive-Compulsive Disorder; PSS: Parental stress scale.*

\newpage
# Figure 2 - Response status at 16 weeks

```{r fig.height=5}
df_bar <- data.frame(table(df$CBOCS_grup,df$group))
colnames(df_bar) <- c("severity","group","freq")
df_bar$perc[df_bar$group == "A"] <- df_bar$freq[df_bar$group == "A"]/sum(df_bar$freq[df_bar$group == "A"])
df_bar$perc[df_bar$group == "B"] <- df_bar$freq[df_bar$group == "B"]/sum(df_bar$freq[df_bar$group == "B"])

df_bar$x_axis[df_bar$group == "A"] <- 1
df_bar$x_axis[df_bar$group == "B"] <- 2

df_bar$cummu_sum[df_bar$group == "A"] <- cumsum(df_bar$perc[df_bar$group == "A"])
df_bar$cummu_sum[df_bar$group == "B"] <- cumsum(df_bar$perc[df_bar$group == "B"])

df_segment <- data.frame(cbind(df_bar$cummu_sum[df_bar$group == "A"],df_bar$cummu_sum[df_bar$group == "B"]))


df_bar$group <- as.character(df_bar$group)
df_bar$group[df_bar$group == "A"] <- 
paste0("A \n (n = ", sum(df_bar$freq[df_bar$group == "A"]), ")") 
df_bar$group[df_bar$group == "B"] <- 
paste0("B \n (n = ", sum(df_bar$freq[df_bar$group == "B"]), ")") 
df_bar$group <- as.factor(df_bar$group)

g1 <- ggplot(df_bar,aes(x=x_axis, fill=forcats::fct_rev(severity), color=forcats::fct_rev(severity), y=perc)) + 
  theme_minimal() +  coord_flip() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(breaks = c(1,2), labels=c(levels(df_bar$group))) +
  theme(legend.position = "top", legend.title = element_blank(),
        axis.title = element_blank(), panel.grid=element_blank()) +
  scale_fill_brewer(guide=guide_legend(reverse = TRUE), palette = "RdYlGn", direction=1) +
  scale_color_brewer(guide=guide_legend(reverse = TRUE), palette = "RdYlGn", direction=1)
 

g1 <-  g1 + geom_segment(aes(x=1.375,xend=1.625,y=0,yend=0), color="grey")

for(i in 1:nrow(df_segment)){
  g1 <-  g1 + geom_segment(aes_string(x=1.375,xend=1.625,y=df_segment[i,1],yend=df_segment[i,2]),color="grey")
}

g1 <- g1 + geom_bar(stat="identity", width=0.75) 


# Proportion of patients no longer meeting the diagnostic criteria for OCD, ICD-10 F.42 assesed with K-SADS-PL (82) at the end of the intervention (remission).

g2 <- ggplot(data=df_bar[df_bar$severity == "0-10 (Remitted)",], aes(x=group, y=perc)) + geom_bar(stat="identity", color=brewer.pal(n = 4, name = "RdYlGn")[4], fill=brewer.pal(n = 4, name = "RdYlGn")[4]) + theme_minimal() +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.title.y=element_blank()) + xlab("Proportion of remitted\n participants at the \n of intervention")
  

# Treatment response based on the definition of a reduction on the CY-BOCS at week 16 of at least 30% in intraindividual comparison with the score at week 0.  
df$Response <- as.numeric(as.character(df$Response))
test <- summarySE(df, measurevar="Response", groupvars="group",na.rm=T)
test$group <- as.character(test$group)
test$group[test$group == "A"] <- 
paste0("A \n (n = ", sum(test$N[test$group == "A"]), ")") 
test$group[test$group == "B"] <- 
paste0("B \n (n = ", sum(test$N[test$group == "B"]), ")") 
test$group <- as.factor(test$group)

g3 <- ggplot(data=test, aes(x=group, y=Response)) + geom_bar(stat="identity") + theme_minimal() +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.title.y=element_blank()) + xlab("Proportion of participants \n with 30% reduction \n at the end of intervention")
  



#ALL three figures
grid.arrange(g1,g2,g3, layout_matrix=rbind(c(1,1),c(2,3)))



```

 

\newpage
# Figure 3 - Negative effects questionnaire 

```{r, fig.height=4}
fig_neq <- figScores(df,"NEQ", xminmax=c(3.5,16.5), simple=F, lin_reg_simple = T)
fig_burden <- ggplot(df, aes(x=group, y=`Negative effect burden`, color=group, fill=group)) + stat_summary(fun=mean, geom="bar", width=0.5) + 
  stat_summary(fun.data=mean_cl_normal, geom="errorbar", width=0.25, color="black") + theme_minimal() +
  scale_color_hue(direction = -1, h.start=90) + scale_fill_hue(direction = -1, h.start=90) + 
  ylab("NEQ per week") + theme(axis.title.x = element_blank())

ggarrange(fig_neq, fig_burden, ncol=1, common.legend=T, legend="bottom") + theme(plot.margin = margin(0.1,0.1,0.1,0.1, "cm"))



```


\newpage
# Supplemental Table 1 - Comorbidities

```{r}
df_t3 <- df[grepl("group|F32.|F40.|F41.|F43.",colnames(df))]
tbl_func(df_t3,strat_var="group",vars=colnames(df_t3), Grepl=T)

```

\newpage
# Supplemental Table 2 - Psychopathological scores

**Numbers from Figure 1**

\newpage
# Supplemental Table 3 - Kidscreen-52

Tabllerne som ovenstående figur 1 bygger på.

* Physical well-being
* Psychological well-being
* Moods and emotions
* Self-perception
* Autonomy
* Parent relation and home life
* Peers and social support
* School environment
* Social acceptance (bullying)
* Financial ressources

\newpage
# Supplemental Timeline
This timeline will, together with the commits to the version control system, function as a log of the statistical process

* 14.04.2021 - The work on the statistical report with simulated data has been initiated.
* 30.04.2021 - First evaluation of presentation of data using simulated tools.
* 03.05.2021 - Second evaluation of the statistical report.
* 11.05.2021 - Third evaluation of the statistical report.
* 14.05.2021 - Fourth evaluation of the statistical report.
* 19.05.2021 - Fifth evaluation of the statistical report.

\newpage
# Supplemental Assumptions
The assumptions for regression models will be assessed using four figures, for each variable.

1. *Residuals vs Fitted*. Used to check the linear relationship assumptions. A horizontal line, without distinct patterns is an indication for a linear relationship, what is good.

2. *Normal Q-Q*. Used to examine whether the residuals are normally distributed. It’s good if residuals points follow the straight dashed line.

3. *Scale-Location* (or Spread-Location). Used to check the homogeneity of variance of the residuals (homoscedasticity). Horizontal line with equally spread points is a good indication of homoscedasticity.

4. *Residuals vs Leverage*. Used to identify influential cases, that is extreme values that might influence the regression results when included or excluded from the analysis.

## CY-BOCS (primary)

```{r fig.height = 5}
autoplot(lm(`CY-BOCS_16` ~ group + `CY-BOCS_0`, data=df)) + theme_minimal()
```

## KIDSCREEN-10 (secondary)
Lorem ipsum...

## NEQ (secondary)
Lorem ipsum...

## COIS (exploratory)
Lorem ipsum...

## CGI-S (exploratory)
Lorem ipsum...

## CGI-I (exploratory)
Lorem ipsum...

## TAFQ-A (exploratory)
Lorem ipsum...

## CGAS (exploratory)
Lorem ipsum...

## TOCS (exploratory)
Lorem ipsum...
