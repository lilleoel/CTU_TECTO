---
title: "Statistical report for \n TECTO trial"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  word_document:
    toc: yes
    toc_depth: '2'
subtitle: Using simulated data
---

```{r setup, include=FALSE}
source("_functions.R")
source("_sim_data.R")
#source("_import_data.R")
#source("_data_handling.R")
#Kruskal wallis if not fullfilled.
```

\newpage
# Table 1 - Baseline characteristics

```{r}
tbl_func(df,strat_var="group",vars=c("Age","Gender","Nationality","Parental education level","Parental nationality",
                                     "Parental stress scale (PSS)","Family Environment Scale (FES)",
                                     "Social responsiveness scale (SRS)","Intelligence (WISC-V/WAIS-IV)"))

```

*The education-level from the parent with the highest education is presented. For PSS, FES, and SRS the average of the parents who responded is presented*


\newpage
# Table 2 - Diagnostic status and comorbidities at baseline

```{r}
df_baseline <- df[,grepl("pt_id|group|_0", colnames(df))]
colnames(df_baseline) <- gsub("_0","",colnames(df_baseline))
tbl_func(df_baseline,strat_var="group",vars=c("CY-BOCS","COIS-R","CGI-S","CGAS","TOCS","TAFQ-A","FAS","Depression","Agoraphobia","Social phobias","Specific phobias","Separation anxiety disorder","Generalized anxiety disorders","Anorexia nervosa","Anxious personality disorder","Adjustment disorders","Asperger syndrome","ADHD","Oppositional defiant disorder","Transient tics","Chronic tics/Tourette’s syndrome","Nonorganic enuresis","Nonorganic encopresis"), Grepl=T)


   

```

\newpage
# Figure 1 - Psychopathological scores

```{r, fig.height=9}

ggarrange(figScores(df,"CY-BOCS", lin_reg=T),
          figScores(df,"COIS-R", lin_reg=T),
          figScores(df,"CGI-S", lin_reg=T),
          figScores(df,"CGI-I", lin_reg_simple=T),
          figScores(df,"CGAS", lin_reg=T),
          figScores(df,"TOCS", lin_reg=T),
          figScores(df,"TAFQ-A", lin_reg=T),
          figScores(df,"FAS", lin_reg=T, simple=F),
             ncol=1, common.legend=T, legend="bottom") +
  theme(plot.margin = margin(0.1,0.1,0.1,0.1, "cm"))

```


\newpage
# Figure 2 - Response Status at 16 weeks

```{r fig.height=3}
df_bar <- data.frame(table(df$CBOCS_grup,df$group))
colnames(df_bar) <- c("severity","group","freq")
df_bar$perc[df_bar$group == "A"] <- df_bar$freq[df_bar$group == "A"]/sum(df_bar$freq[df_bar$group == "A"])
df_bar$perc[df_bar$group == "B"] <- df_bar$freq[df_bar$group == "B"]/sum(df_bar$freq[df_bar$group == "B"])

df_bar$x_axis[df_bar$group == "A"] <- 1
df_bar$x_axis[df_bar$group == "B"] <- 2

df_bar$cummu_sum[df_bar$group == "A"] <- cumsum(df_bar$perc[df_bar$group == "A"])
df_bar$cummu_sum[df_bar$group == "B"] <- cumsum(df_bar$perc[df_bar$group == "B"])

df_segment <- data.frame(cbind(df_bar$cummu_sum[df_bar$group == "A"],df_bar$cummu_sum[df_bar$group == "B"]))


df_bar$group <- as.character(df_bar$group)
df_bar$group[df_bar$group == "A"] <- 
paste0("A \n (n = ", sum(df_bar$freq[df_bar$group == "A"]), ")") 
df_bar$group[df_bar$group == "B"] <- 
paste0("B \n (n = ", sum(df_bar$freq[df_bar$group == "B"]), ")") 
df_bar$group <- as.factor(df_bar$group)




g1 <- ggplot(df_bar,aes(x=x_axis, fill=forcats::fct_rev(severity), color=forcats::fct_rev(severity), y=perc)) + 
  theme_minimal() +  coord_flip() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(breaks = c(1,2), labels=c(levels(df_bar$group))) +
  theme(legend.position = "top", legend.title = element_blank(),
        axis.title = element_blank(), panel.grid=element_blank()) +
  scale_fill_brewer(guide=guide_legend(reverse = TRUE), palette = "YlOrRd", direction=-1) +
  scale_color_brewer(guide=guide_legend(reverse = TRUE), palette = "YlOrRd", direction=-1)
 

g1 <-  g1 + geom_segment(aes(x=1.375,xend=1.625,y=0,yend=0), color="grey")

for(i in 1:nrow(df_segment)){
  g1 <-  g1 + geom_segment(aes_string(x=1.375,xend=1.625,y=df_segment[i,1],yend=df_segment[i,2]),color="grey")
}

g1 + geom_bar(stat="identity", width=0.75) 

```

 

\newpage
# Figure 3 - Negative Effects Questionnaire 

```{r, fig.height=2.5}

ggarrange(figScores(df,"NEQ", xminmax=c(3.5,16.5), simple=F, lin_reg_simple = T)) + theme(plot.margin = margin(0.1,0.1,0.1,0.1, "cm"))

```


\newpage

# Supplemental Table 1 - Diagnostic scores

Tabllerne som ovenstående figur 1 bygger på.

\newpage
# Supplemental Timeline
This timeline will, together with the commits to the version control system, function as a log of the statistical process

* 14.04.2021 - The work on the statistical report with simulated data has been initiated.
* 30.04.2021 - First evaluation of presentation of data using simulated tools.
* 03.05.2021 - Second evaluation of the statistical report.
* 11.05.2021 - Third evaluation of the statistical report.

\newpage
# Supplemental Assumptions
The assumptions for regression models will be assessed using four figures, for each variable.

1. *Residuals vs Fitted*. Used to check the linear relationship assumptions. A horizontal line, without distinct patterns is an indication for a linear relationship, what is good.

2. *Normal Q-Q*. Used to examine whether the residuals are normally distributed. It’s good if residuals points follow the straight dashed line.

3. *Scale-Location* (or Spread-Location). Used to check the homogeneity of variance of the residuals (homoscedasticity). Horizontal line with equally spread points is a good indication of homoscedasticity.

4. *Residuals vs Leverage*. Used to identify influential cases, that is extreme values that might influence the regression results when included or excluded from the analysis.

## CY-BOCS (primary)

```{r fig.height = 5}
autoplot(lm(`CY-BOCS_16` ~ group + `CY-BOCS_0`, data=df)) + theme_minimal()
```

## KIDSCREEN-10 (secondary)

```{r fig.height = 5}
autoplot(lm(`CY-BOCS_16` ~ group + `CY-BOCS_0`, data=df)) + theme_minimal()
```

## NEQ (secondary)
32 ITEMS

## COIS (exploratory)
COIS

## CGI-S (exploratory)
COIS

## CGI-I (exploratory)
COIS

## TAFQ-A (exploratory)
COIS

## CGAS (exploratory)
COIS

## TOCS (exploratory)
COIS

Clinical state (CY-BOCS, KIDSCREEN, COIS**, CGI-S, CGI-I (not at week 0),  TAFQ-A*)
C-GAS
Self-report OCD rating (TOCS)
Diagnostics (K-SADS-PL)
Intelligence (WISC-V/WAIS-IV)
Social competences (SRS)
Negative effects of psychotherapy (NEQ)
PSS, Family accomodation (FAS)
Family Environment (FES)**
Treatment compliance
Experience of service questionnaire

